#include <stdio.h>
#include <stdint.h>
#include <sys/mman.h>
#include <string.h>

#define CODE_SIZE 100

typedef int (*fib_func)(int);

int main() {
  void *mem = mmap(NULL, CODE_SIZE, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_ANON | MAP_PRIVATE, -1, 0);
  if (mem == MAP_FAILED) {
    perror("mmap");
    return 1;
  }
  unsigned char fib_code[] = {
    0x55,0x48,0x89,0xe5,0x48,0x81,0xec,0xc8,0x00,0x00,0x00,0x48,0x89,0x7d,0xf8,0x83,
    0x7d,0xf8,0x00,0x0f,0x8f,0x0c,0x00,0x00,0x00,0x48,0xc7,0xc0,0x00,0x00,0x00,0x00,
    0xe9,0x4e,0x00,0x00,0x00,0x83,0x7d,0xf8,0x01,0x0f,0x85,0x0c,0x00,0x00,0x00,0x48,
    0xc7,0xc0,0x01,0x00,0x00,0x00,0xe9,0x38,0x00,0x00,0x00,0x48,0x8b,0x45,0xf8,0x48,
    0x83,0xe8,0x01,0x48,0x89,0xc7,0xe8,0xb5,0xff,0xff,0xff,0x48,0x89,0x45,0xf0,0x48,
    0x8b,0x55,0xf8,0x48,0x83,0xea,0x02,0x48,0x89,0xd7,0xe8,0xa1,0xff,0xff,0xff,0x48,
    0x89,0x45,0xe8,0x48,0x8b,0x4d,0xf0,0x48,0x03,0x4d,0xe8,0x48,0x89,0xc8,0xe9,0x00,
    0x00,0x00,0x00,0x48,0x89,0xec,0x5d,0xc3,
  };

  memcpy(mem, fib_code, sizeof(fib_code));

  fib_func fib = (fib_func)mem;

  int result = fib(40);
  printf("Fibonacci of 40: %d\n", result);

  munmap(mem, CODE_SIZE);

  return 0;
}
